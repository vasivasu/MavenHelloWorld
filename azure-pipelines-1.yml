# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
  branches:
    include:
      - master
    paths:
      include:
        - Dockerfile

pool:
  vmImage: 'ubuntu-latest'

stages:

# ğŸ³ Stage 1 â€” Docker Build + Push
- stage: Docker_Build_Push
  jobs:
  - job: BuildPush
    steps:
    - checkout: self

    - task: Docker@2
      displayName: "Login to Docker Hub"
      inputs:
        command: login
        containerRegistry: 'docker_hub'

    - task: Docker@2
      displayName: "Build & Push Docker Image"
      inputs:
        command: buildAndPush
        containerRegistry: 'docker_hub'
        repository: 'delete_me'
        Dockerfile: 'Dockerfile'
        buildContext: '.'
        tags: |
          latest


# # ğŸš€ Stage 2 â€” Deploy Container to VM
# - stage: Deploy
#   dependsOn: Docker_Build_Push
#   jobs:
#   - job: DeployToVM
#     pool:
#       name: 'Default' # self-hosted agent in your VM
#     steps:
#     - script: |
#         sudo docker stop webapp || true
#         sudo docker rm webapp || true
#         sudo docker pull <username>/delete_me:latest
#         sudo docker run -d --name webapp -p 8080:8080 <username>/delete_me:latest
#       displayName: "Run Container on VM"

