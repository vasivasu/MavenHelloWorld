trigger:
- master

stages:
# =======================
# ðŸš€ STAGE 1: BUILD WAR
# =======================
- stage: Build
  displayName: "QA_Stage"
  jobs:
  - job: BuildJob
    displayName: "Build WAR and Publish Artifact"
    pool:
      vmimage: 'windows-latest'
    steps:
    - task: Maven@3
      displayName: "Build with Maven"
      inputs:
        mavenPomFile: 'webapp/pom.xml'
        mavenOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        goals: 'clean package'

    - task: CopyFiles@2
      displayName: "Copy WAR to Artifact Staging"
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: '**/*.war'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: "Publish Artifact (drop)"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'


# =======================
# ðŸ”¥ STAGE 2: DEPLOY WAR
# =======================
- stage: Deploy
  displayName: "Deploy to Tomcat"
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: "Copy WAR and Restart Tomcat Service"
    pool:
      name: 'Default'   # self-hosted agent on your VM
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: "Download Build Artifact"
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(Pipeline.Workspace)'

    - script: |
    echo "Stopping Tomcat..."
    sudo /opt/tomcat/bin/shutdown.sh || true
    sleep 5

    echo "Copying WAR file..."
    sudo cp $(Pipeline.Workspace)/drop/webapp/target/webapp.war /opt/tomcat/webapps/webapp.war

    echo "Starting Tomcat..."
    sudo /opt/tomcat/bin/startup.sh
    sleep 10

    echo "Deployment Completed Successfully!"
  displayName: "Deploy WAR to Tomcat"

