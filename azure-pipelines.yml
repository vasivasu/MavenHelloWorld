trigger:
- master

stages:
# =======================
# ðŸš€ STAGE 1: BUILD WAR
# =======================
- stage: Build
  displayName: "QA_Stage"
  jobs:
  - job: BuildJob
    displayName: "Build WAR and Publish Artifact"
    pool:
      vmimage: 'windows-latest'
    steps:
    - task: Maven@3
      displayName: "Build with Maven"
      inputs:
        mavenPomFile: 'webapp/pom.xml'
        mavenOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        goals: 'clean package'

    - task: CopyFiles@2
      displayName: "Copy WAR to Artifact Staging"
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: '**/*.war'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: "Publish Artifact (drop)"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'


# =======================
# ðŸ”¥ STAGE 2: DEPLOY WAR
# =======================
- stage: Deploy
  displayName: "Deploy to Tomcat"
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: "Copy WAR and Restart Tomcat Service"
    pool:
      name: 'won_delete'
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: "Download Build Artifact"
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(Pipeline.Workspace)'

    - task: PowerShell@2
      displayName: "Deploy WAR to Tomcat"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Stopping Tomcat..."
          & "C:\tomcat\bin\shutdown.bat"
          Start-Sleep -Seconds 5
          
          Write-Host "Removing old deployment..."
          Remove-Item "C:\tomcat\webapps\webapp" -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host "Copying WAR file..."
          Copy-Item "$(Pipeline.Workspace)\drop\webapp\target\webapp.war" "C:\tomcat\webapps\webapp.war" -Force
          
          Write-Host "Restarting Tomcat..."
          & "C:\tomcat\bin\startup.bat"
          Start-Sleep -Seconds 10
          
          Write-Host "Deployment Completed Successfully!"
